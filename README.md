# 🌤️ ESP32 Метеостанция

[![PlatformIO](https://img.shields.io/badge/PlatformIO-ESP32-blue.svg)](https://platformio.org/)
[![Version](https://img.shields.io/badge/Version-1.1-green.svg)]()

## 📖 Описание

ESP32 Метеостанция - это интеллектуальная система мониторинга окружающей среды, построенная на базе микроконтроллера ESP32. Проект обеспечивает сбор, обработку и визуализацию данных о температуре, влажности и концентрации CO2 в реальном времени с возможностью построения графиков за различные временные периоды.

### ✨ Основные возможности

- 📊 **Мониторинг в реальном времени** - температура, влажность, CO2
- 📈 **Графическое отображение** - столбчатые диаграммы за разные периоды
- 🕐 **Точное время** - синхронизация с RTC модулем DS3231
- 🎛️ **Интуитивное управление** - энкодер и кнопка для навигации
- 💾 **Буферизация данных** - эффективное хранение временных рядов
- 🔄 **Многозадачность** - параллельная обработка данных и отображения

## 🏗️ Аппаратная архитектура

### Компоненты системы
┌─────────────────────────────┬────────────────┬─────────────────────────────┐
│            Компонент        │     Модель     │          Назначение         │
├─────────────────────────────┼────────────────┼─────────────────────────────┤
│ **Микроконтроллер**         │ ESP32 WROOM 32 │ Основной процессор          │
│ **Датчик окружающей среды** │ SCD4x          │ CO2, температура, влажность │
│ **Модуль времени**          │ DS3231         │ Часы реального времени      │
│ **Дисплей**                 │ LCD 2004       │ Отображение информации      │
│ **Управление**              │ Энкодер EC11   │ Навигация по меню           │
└─────────────────────────────┴────────────────┴─────────────────────────────┘
### Схема подключения

```
ESP32 Pin Mapping:
┌─────────────────┬─────────┬─────────────────────┐
│ ESP32 Pin       │ Тип     │ Подключение         │
├─────────────────┼─────────┼─────────────────────┤
│ Pin 25          │ INPUT   │ Кнопка (PULLUP)     │
│ Pin 32          │ INPUT   │ Энкодер A (PULLUP)  │
│ Pin 33          │ INPUT   │ Энкодер B (PULLUP)  │
│ Pin 16 (Wire1)  │ I2C SDA │ LCD дисплей         │
│ Pin 17 (Wire1)  │ I2C SCL │ LCD дисплей         │
│ Pin 21 (Wire)   │ I2C SDA │ SCD4x + DS3231      │
│ Pin 22 (Wire)   │ I2C SCL │ SCD4x + DS3231      │
└─────────────────┴─────────┴─────────────────────┘
```

## 📚 Программные зависимости

### Основные библиотеки
┌───────────────────────┬────────┬─────────────────────────────────────┐
│      Библиотека       │ Версия │              Назначение             │
├───────────────────────┼────────┼─────────────────────────────────────┤
│ RTClib                │ GitHub │ Работа с RTC модулем DS3231         │
│ LiquidCrystal_PCF8574 │ GitHub │ Управление LCD дисплеем             │
│ SparkFun SCD4x        │ GitHub │ Датчик CO2, температуры и влажности │
└───────────────────────┴────────┴─────────────────────────────────────┘
## 🎮 Пользовательский интерфейс

### Структура меню

```
┌─────────────────────────────────────┐
│ [Часы] - Цифровой дисплей времени   │
│ [Метеоданные] - Текущие показания   │
│ [Температура] - Графики за периоды  │
│ [Влажность] - Графики за периоды    │
│ [CO2] - Графики за периоды          │
│ [Comp DATA] - Сравнение данных      │
│ [Тест 1] - Тестовое окно            │
│ [Тест 2] - Тестовое окно            │
│ [Настройки] - Конфигурация системы  │
└─────────────────────────────────────┘
```

### Подменю для графиков

Каждый параметр (температура, влажность, CO2) имеет подменю с временными интервалами:
- **1 минута** - 12 столбцов данных
- **10 минут** - 10 столбцов данных  
- **2 часа** - 12 столбцов данных
- **1 день** - 12 столбцов данных
- **12 дней** - 12 столбцов данных

### Управление

- **🔄 Энкодер**: Навигация между пунктами меню
- **🔘 Кнопка**: Переключение режимов меню/подменю

## 💾 Система данных

### Класс FloatDeque

Эффективный циклический буфер для хранения временных рядов:

```cpp
class FloatDeque {
public:
    void push_front(float value);  // Добавить в начало
    void push_back(float value);   // Добавить в конец
    void pop_front();              // Удалить из начала
    void pop_back();               // Удалить с конца
    float average();               // Среднее значение
    void copyToArray(float* destArray, uint8_t length);
    bool isFull();                 // Проверка заполненности
    uint8_t size();                // Текущий размер
};
```

### Структура метеоданных

```cpp
struct MeteoData {
    float temperature;    // °C
    float humidity;       // %
    float co2;           // ppm
    DateTime timestamp;   // Время измерения
};
```

## ⚡ Многозадачная архитектура

### Основные задачи
1. **Основной цикл (Core 1)**: Отображение данных на LCD
2. **Сбор данных (Core 0)**: Периодический сбор метеоданных

### Планировщик задач

```cpp
// Создание задачи сбора данных
xTaskCreatePinnedToCore(
    writeMeteoData,        // Функция задачи
    "writeMeteoData",      // Имя задачи
    2048,                  // Размер стека
    NULL,                  // Параметры
    1,                     // Приоритет
    NULL,                  // Handle задачи
    0                      // Ядро (Core 0)
);
```

## 🔧 Функциональность

### 1. 📅 Отображение времени
- Цифровой дисплей с кастомными символами
- Автоматическая синхронизация с RTC DS3231
- Ручная настройка времени при первом запуске
- Формат: `HH:MM:SS`

### 2. 🌡️ Сбор метеоданных
- Автоматический сбор каждые 5 секунд
- Одновременное измерение всех параметров
- Буферизация для построения графиков
- Обработка ошибок датчиков

### 3. 📊 Графическое отображение
- Столбчатые диаграммы для всех параметров
- Автоматическое масштабирование
- Отображение текущих и средних значений
- Кастомные символы для визуализации

### 4. ⚙️ Система настроек
- Настройка времени и даты
- Сброс накопленных данных

## 🚀 Установка и настройка

### Предварительные требования

- **PlatformIO IDE** или **Arduino IDE**
- **ESP32 Board Package**
- **Git** для клонирования репозитория

### Пошаговая установка

1. **Клонирование репозитория**
   ```bash
   git clone https://github.com/your-username/ESP32_MeteoStation.git
   cd ESP32_MeteoStation
   ```

2. **Установка зависимостей**
   ```bash
   pio lib install
   ```

3. **Подключение компонентов**
   - Следуйте схеме подключения выше
   - Убедитесь в правильности соединений

4. **Загрузка прошивки**
   ```bash
   pio run --target upload
   ```

5. **Мониторинг**
   ```bash
   pio device monitor
   ```

### Первый запуск

1. Система автоматически определит отсутствие настроенного времени
2. Запустится режим ручной настройки времени
3. После настройки система перейдет в рабочий режим
4. Начнется сбор метеоданных

## 🔍 Диагностика и отладка

### Проверка подключения

┌───────────┬───────────────────┬───────────────────────────┐
│ Компонент │     Индикатор     │     Действие при ошибке   │
├───────────┼───────────────────┼───────────────────────────┤
│ **SCD4x** │ "SCD4x not found" │ Проверить I2C подключение │
│ **RTC**   │ "RTC not found"   │ Проверить питание и I2C   │
│ **LCD**   │ Автоинициализация │ Проверить I2C адрес       │
└───────────┴───────────────────┴───────────────────────────┘

### Отладочная информация

- **Serial Monitor**: 115200 baud
- **Вывод ошибок**: Статус подключения компонентов
- **Логирование**: Отладочные сообщения

### Частые проблемы

┌────────────────────┬───────────────────────────────────┐
│      Проблема      │               Решение             │
├────────────────────┼───────────────────────────────────┤
│ Датчик не найден   │ Проверить I2C адрес и подключение │
│ Неточные показания │ Выполнить калибровку датчика      │
│ Медленная работа   │ Проверить частоту I2C             │
└────────────────────┴───────────────────────────────────┘

## 📈 Технические характеристики

### Производительность

┌──────────────────────────┬──────────────┬──────────────────┐
│        Параметр          │   Значение   │     Описание     │
├──────────────────────────┼──────────────┼──────────────────┤
│ **Частота обновления**   │ 1 раз/5 с.   │ Сбор метеоданных │
│ **Точность времени**     │ ±5 ppm       │ DS3231           │
│ **Точность CO2**         │ ±50 ppm + 5% │ SCD4x            │
│ **Точность температуры** │ ±0.5°C       │ SCD4x            │
│ **Точность влажности**   │ ±3% RH       │ SCD4x            │
└──────────────────────────┴──────────────┴──────────────────┘
## 🔮 Планы развития

### Краткосрочные улучшения

- [ ] **WiFi подключение** - отправка данных в облако
- [ ] **SD карта** - долгосрочное хранение данных
- [ ] **Долнительные датчики** 
- [ ] **Алерты** - уведомления о критических значениях

### Долгосрочные планы

- [ ] **MQTT интеграция** - для IoT платформ
- [ ] **Экспорт данных** - CSV/JSON форматы


## 🙏 Благодарности

- **SparkFun** - за библиотеку SCD4x
- **Adafruit** - за библиотеку RTClib
- **Mathertel** - за библиотеку LiquidCrystal_PCF8574
- **Arduino Community** - за поддержку и вдохновение

---

Разработано для образовательных целей в области IoT и встраиваемых систем.

---

*Документация обновлена: [13.06.25]*
*Версия прошивки: 1.1* 